angular.module("MyApp").factory("Auth",["$http","$location","$rootScope","$routeParams","$alert","$window","fb_appId","fb_connect","Invites","updateInvites","AuthProfile",function(e,t,o,n,a,i,r,u,s,c,l){var d=i.localStorage.token;if(d){var p=JSON.parse(i.atob(d.split(".")[1]));o.currentUser=p.user}return i.fbAsyncInit=function(){FB.init({appId:r,responseType:"token",version:"v2.2",oauth:!0,xfbml:!0})},function(e,t,o){var n,a=e.getElementsByTagName(t)[0];e.getElementById(o)||(n=e.createElement(t),n.id=o,n.src=u,a.parentNode.insertBefore(n,a))}(document,"script","facebook-jssdk"),{facebookLogin:function(){n.id?c.get({_id:n.id},function(n){n?n.invitations_accepted<10?FB.login(function(r){FB.api("/me",function(u){var s={signedRequest:r.authResponse.signedRequest,profile:u};l.get({_id:u.id},function(n){n&&e.post("/auth/facebook",s).success(function(e){console.log("Data: "+s);var n=JSON.parse(i.atob(e.split(".")[1]));i.localStorage.token=e,o.currentUser=n.user,t.path("/"),a({title:"Cheers!",content:"You have successfully signed-in with Facebook.",animation:"fadeZoomFadeDown",type:"material",duration:3})}).error(function(){delete i.localStorage.token,a({title:"Error!",content:"Could not sign-in",animation:"fadeZoomFadeDown",type:"material",duration:3})})}),e.post("/auth/facebook",s).success(function(e){console.log("Data: "+s);var r=JSON.parse(i.atob(e.split(".")[1]));i.localStorage.token=e,o.currentUser=r.user,n.$update(function(){}),t.path("/"),a({title:"Cheers!",content:"You have successfully signed-in with Facebook.",animation:"fadeZoomFadeDown",type:"material",duration:3})}).error(function(){delete i.localStorage.token,a({title:"Error!",content:"Could not sign-in",animation:"fadeZoomFadeDown",type:"material",duration:3})})})},{scope:"email, public_profile, user_friends, publish_actions"}):(a({title:"Maximum number of invites reached for the invitation",content:"Could not sign-in",animation:"fadeZoomFadeDown",type:"material",duration:3}),t.path("/")):(a({title:"Incorrect invitation",content:"Could not sign-in",animation:"fadeZoomFadeDown",type:"material",duration:3}),t.path("/"))}):FB.login(function(n){FB.api("/me",function(r){var u={signedRequest:n.authResponse.signedRequest,profile:r};l.get({_id:r.id},function(n){n?e.post("/auth/facebook",u).success(function(e){var n=JSON.parse(i.atob(e.split(".")[1]));i.localStorage.token=e,o.currentUser=n.user,t.path("/"),a({title:"Cheers!",content:"You have successfully signed-in with Facebook.",animation:"fadeZoomFadeDown",type:"material",duration:3})}).error(function(){delete i.localStorage.token,a({title:"Error!",content:"Could not sign-in",animation:"fadeZoomFadeDown",type:"material",duration:3})}):a({title:"Invitation error!",content:"You do not have an invitation",animation:"fadeZoomFadeDown",type:"material",duration:3})})})},{scope:"email, public_profile, user_friends, publish_actions"})},logout:function(){delete i.localStorage.token,o.currentUser=null,t.path("/"),FB.logout(function(){}),a({content:"You have been logged out.",animation:"fadeZoomFadeDown",type:"material",duration:3})}}}]);