angular.module("MyApp").factory("Auth",["$http","$location","$rootScope","$routeParams","$alert","$window","fb_appId","fb_connect","Invites","updateInvites","AuthProfile",function(o,e,t,n,i,a,r,s,c,u,l){var p=a.localStorage.token;if(p){var d=JSON.parse(a.atob(p.split(".")[1]));t.currentUser=d.user}return a.fbAsyncInit=function(){FB.init({appId:r,responseType:"token",version:"v2.2",oauth:!0,xfbml:!0})},function(o,e,t){var n,i=o.getElementsByTagName(e)[0];o.getElementById(t)||(n=o.createElement(e),n.id=t,n.src=s,i.parentNode.insertBefore(n,i))}(document,"script","facebook-jssdk"),{facebookLogin:function(){n.id?u.get({_id:n.id},function(n){console.log(n),n._id?FB.login(function(r){FB.api("/me",function(s){var c={signedRequest:r.authResponse.signedRequest,profile:s};l.get({_id:s.id},function(n){n._id&&o.post("/auth/facebook",c).success(function(o){console.log("Data: "+c);var n=JSON.parse(a.atob(o.split(".")[1]));a.localStorage.token=o,t.currentUser=n.user,e.path("/")}).error(function(){delete a.localStorage.token,i({title:"Error!",content:"Could not sign-in",animation:"fadeZoomFadeDown",type:"material",duration:3})})}),o.post("/auth/facebook",c).success(function(o){console.log("Data: "+c);var i=JSON.parse(a.atob(o.split(".")[1]));a.localStorage.token=o,t.currentUser=i.user,n.$update(function(){}),e.path("/")}).error(function(){delete a.localStorage.token,i({title:"Error!",content:"Could not sign-in",animation:"fadeZoomFadeDown",type:"material",duration:3})})})},{scope:"email, public_profile, user_friends, publish_actions"}):(alert("Incorrect invitation"),e.path("/"))}):FB.login(function(n){FB.api("/me",function(r){var s={signedRequest:n.authResponse.signedRequest,profile:r};l.get({_id:r.id},function(n){n._id?(console.log("Signing in"),o.post("/auth/facebook",s).success(function(o){var n=JSON.parse(a.atob(o.split(".")[1]));a.localStorage.token=o,t.currentUser=n.user,e.path("/home")}).error(function(){delete a.localStorage.token,i({title:"Error!",content:"Could not sign-in",animation:"fadeZoomFadeDown",type:"material",duration:3})})):(alert("You require an invitation to sign up"),console.log("You do not have an invitation"))})})},{scope:"email, public_profile, user_friends, publish_actions"})},logout:function(){delete a.localStorage.token,t.currentUser=null,FB.getLoginStatus(function(o){o&&"connected"===o.status&&FB.logout(function(){a.location="/"})}),a.location="/"}}}]);