#!/usr/bin/env node

function ensureAuthenticated(e,i,t){if(!e.headers.authorization)return i.set("Content-Type","application/json"),i.staus(401).end();var n=e.headers.authorization.split(" ")[1];try{var o=jwt.decode(n,tokenSecret);if(!(o.exp<=Date.now()))return e.user=o.user,t();i.status(400).send("Access token has expired")}catch(r){return i.status(500).send("Error parsing token")}}function createJwtToken(e){var i={user:e,iat:(new Date).getTime(),exp:moment().add("days",7).valueOf()};return jwt.encode(i,tokenSecret)}if(process.env.NODE_ENV||(process.env.NODE_ENV="prod"),"dev"===process.env.NODE_ENV){var config=require("./config.dev.json"),s3_config=require("./s3_config.json");process.env.PORT=3e3}else{var config=require("./config.prod.json"),s3_config=require("./s3_config.json");process.env.PORT=8080}console.log(process.env.NODE_ENV);var path=require("path"),gm=require("gm"),util=require("util"),http=require("http"),httpProxy=require("http-proxy"),express=require("express"),timeout=require("connect-timeout"),bodyParser=require("body-parser"),logger=require("morgan"),multipart=require("connect-multiparty"),router=express.Router(),session=require("cookie-session"),cookieParser=require("cookie-parser"),crypto=require("crypto"),bcrypt=require("bcryptjs"),mongoose=require("mongoose"),jwt=require("jwt-simple"),moment=require("moment"),async=require("async"),request=require("request"),xml2js=require("xml2js"),textSearch=require("mongoose-text-search"),agenda=require("agenda")({db:{address:config.db}}),sugar=require("sugar"),nodemailer=require("nodemailer"),sendgrid=require("sendgrid")(config.sendgrid.id,config.sendgrid.password),_=require("lodash"),cors=require("express-cors"),argv=require("optimist").argv,fs=require("fs"),AWS=require("aws-sdk");AWS.config=s3_config;var s3=new AWS.S3,buf=new Buffer(""),tokenSecret=config.tokenSecret,activitySchema=new mongoose.Schema({_id:String,title:String,dateOfActivity:String,endDateOfActivity:String,timeOfActivity:String,city:String,location:String,address:String,phone:String,sourceWebsite:String,sourceName:String,sourceDescription:String,locationWebsite:String,neighborhood:String,country:String,genre:[String],description:String,poster:String,photoCredit:String,photoCreditLink:String,currency:String,price:String,timeAdded:{type:Date,"default":Date.now()},facebookLink:String,twitterLink:String,zomatoLink:String,payment:String,bookRide:String,goodies:String,moreInfo:String,moreInfoLink:String,operatingDays:[String],operatingTime:[String],addedBy:String,mapLat:{type:Number,"default":12.9667},mapLon:{type:Number,"default":77.5667},corner:String,cornerPic:String,cornerText:String,preview:Boolean,tips:[{text:String,tipperfbId:String,tipper:{type:mongoose.Schema.Types.ObjectId,ref:"User"}}],tipper:[{type:mongoose.Schema.Types.ObjectId,ref:"User"}],selfies:[{url:String,fbId:String}],selfie_sub:[{type:mongoose.Schema.Types.ObjectId,ref:"User"}],subscribers:[{type:mongoose.Schema.Types.ObjectId,ref:"User"}],subscriptions:{type:Number,"default":0},doneIt:[{type:mongoose.Schema.Types.ObjectId,ref:"User"}],completions:{type:Number,"default":0},media:[{title:String,text:String,link:String}]}),userSchema=new mongoose.Schema({name:{type:String,trim:!0,required:!0},gender:String,age:String,curator:Boolean,p2p:Boolean,facebookId:String,facebook:{id:String,email:String,profileLink:String},google:{id:String,email:String},subscribedActivities:[{type:String}],subscriptions:{type:Number,"default":0},doneActivities:[{type:String}],requests:[String],invitation_to:[String],invitations_sent:{type:Number,"default":0},inviteString:String,completions:{type:Number,"default":0},tipsCount:{type:Number,"default":0},selfies:[String]}),invitesSchema=new mongoose.Schema({_id:String,invitations_accepted:{type:Number,"default":0}}),User=mongoose.model("User",userSchema),Activity=mongoose.model("Activity",activitySchema),Invites=mongoose.model("Invites",invitesSchema);mongoose.connect("mongodb://bhuvan:joyage_database_password@ds035280.mongolab.com:35280/joyage_database");var app=express();app.use(logger("dev")),app.use(bodyParser.json()),app.use(bodyParser.urlencoded()),app.use(express["static"](path.join(__dirname,"public"))),app.use(multipart({uploadDir:"./tmp"})),app.use(cookieParser("$#!secretkeyforjoyage()*")),app.use(session({secret:"$%^jshdvf~98678*"})),app.use(function(e,i,t){"/robots.txt"==e.url?(i.type("text/plain"),i.send("User-agent: *\nDisallow: /images/")):t()}),app.use(function(e,i,t){"/humans.txt"==e.url?(i.type("text/plain"),i.send("<b>Developers</b>\nBhuvan Arora\nbhuvan.aurora@gmail.com")):t()}),app.post("/auth/facebook",function(e,i,t){var n=e.body.profile,o=e.body.signedRequest,r=o.split(".")[0],s=o.split(".")[1],d=config.facebook.appSecret,a=crypto.createHmac("sha256",d).update(s).digest("base64");return a=a.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""),r!==a?i.send(400,"Invalid Request Signature"):void User.findOne({facebookId:n.id},function(o,r){if(r){var s=createJwtToken(r);return e.session.loginTime=Date.now(),i.send(s)}var d=new User({name:n.first_name,gender:n.gender,age:n.age_range,curator:!1,p2p:!1,facebookId:n.id,facebook:{id:n.id,email:n.email,profileLink:n.link},subscribedActivities:[],doneActivities:[],requests:[],invitation_to:[],invitations_sent:0,inviteString:"",tipsCount:0,selfies:[]});d.save(function(n){if(n)return t(n);var o=createJwtToken(d);e.session.loginTime=Date.now(),i.send(o)})})}),app.get("/api/users",function(e,i,t){return e.query.email?void User.findOne({email:e.query.email},function(e,n){return e?t(e):void i.send({available:!n})}):i.send(400,{message:"Email parameter is required."})}),app.get("/mob_api/user",function(e,i,t){return e.query.userId?void User.findOne({_id:e.query.userId},function(e,n){return e?t(e):void i.send(n)}):i.send(400,{message:"UserId parameter is required."})}),app.get("/api/profile/:id",ensureAuthenticated,function(e,i,t){User.findById(e.params.id,function(e,n){return e?t(e):void i.send(n)})}),app.get("/api/authprofile/:id",function(e,i,t){var n=User.findOne({facebookId:e.params.id});n.exec(function(e,n){e&&t(e),i.send(n)})}),app.put("/api/profile/:id",ensureAuthenticated,function(e,i,t){User.findById(e.params.id,function(n,o){return n?t(n):(o.requests.push(e.body.requests),o.invitation_to.push(e.body.invitation_to),o.invitations_sent+=e.body.invitations_sent,o.inviteString=e.body.inviteString,void o.save(function(e){return e?t(e):void i.status(200).end()}))})}),app.post("/api/invites",ensureAuthenticated,function(e,i,t){var n=new Invites({_id:e.body.id});n.save(function(e){return e?t(e):void i.status(200).end()})}),app.get("/api/invites/:id",function(e,i,t){Invites.findById(e.params.id,function(e,n){return e?t(e):void i.send(n)})}),app.put("/api/invites/:id",function(e,i,t){Invites.findById(e.params.id,function(e,n){e&&t(e),n.invitations_accepted+=1,n.save(function(e){e&&t(e),i.status(200).end})})});var converter=require("json-2-csv");app.get("/api/ios_activities",function(e,i,t){var n=Activity.find();n.sort("tineAdded");var o=[];n.exec(function(e,n){if(e)return t(e);for(var r=0;2>r;r++)converter.json2csv(n[r],function(e,i){if(e)throw e;o=i}),console.log(o);i.send(o)})}),app.get("/api/and_activities",function(e,i,t){var n=Activity.find();n.sort("timeAdded"),n.exec(function(e,n){e&&t(e),i.send(n)})}),app.get("/api/session",function(e,i){return i.status(200).json(Date.now()-e.session.loginTime>72e5?{session:"expired"}:{session:"OK"})}),app.get("/api/activities",function(e,t,n){var o=Activity.find();e.query.genre&&e.query.limit?o.where({genre:e.query.genre}).where({city:e.query.city}).limit(e.query.limit):e.query.genre?"timeAdded"===e.query.sortOrder?o.where({genre:e.query.genre}).where({city:e.query.city}).where({preview:{$ne:!1}}).sort("timeAdded").skip(15*(e.query.page-1)).limit(15):"popularity"===e.query.sortOrder?o.where({genre:e.query.genre}).where({city:e.query.city}).where({preview:{$ne:!1}}).sort("-subscriptions").skip(15*(e.query.page-1)).limit(15):"dateOfActivity"===e.query.sortOrder&&o.where({dateOfActivity:{$exists:!1}}).where({city:e.query.city}).where({preview:{$ne:!1}}).where({genre:e.query.genre}).sort({dateOfActivity:-1}).skip(15*(e.query.page-1)).limit(15):e.query.limit?o.where({preview:{$ne:!1}}).where({city:e.query.city}).where({dateOfActivity:{$exists:!1}}).limit(e.query.limit):"dateOfActivity"===e.query.sortOrder?o.where("dateOfActivity").where({city:e.query.city}).where({preview:{$ne:!1}}).gte((new Date).valueOf()).sort("-dateOfActivity").skip(15*(e.query.page-1)).limit(15):"timeAdded"===e.query.sortOrder?o.sort("timeAdded").where({city:e.query.city}).where({preview:{$ne:!1}}).skip(15*(e.query.page-1)).limit(15):"popularity"===e.query.sortOrder?o.sort("-subscriptions").where({city:e.query.city}).where({preview:{$ne:!1}}).skip(15*(e.query.page-1)).limit(15):o.sort("timeAdded").skip(15*(e.query.page-1)).where({city:e.query.city}).where({preview:{$ne:!1}}).limit(15),e.query.preview&&o.where({preview:e.query.preview});var r=(new Date).getTime();act=[];var s=0;o.exec(function(o,d){if(o)return n(o);if(e.query.limit)t.send(d);else{for(i=0;i<d.length;i++)r<=Date.parse(d[i].dateOfActivity)?(act[s]=d[i],++s):d[i].dateOfActivity?""===d[i].dateOfActivity&&(act[s]=d[i],++s):(act[s]=d[i],++s);t.send(act)}})});var mime=require("mime");app.get("/api/activities/:id",function(e,i,t){Activity.findById(e.params.id,function(e,n){return e?t(e):void i.send(n)})}),app.post("/upload",function(e,i){var t=path.join(__dirname,e.files.file.path);gm(t).resize(900,500).stream(function(t,n){var o=new Buffer(""),r=Date.now()+e.files.file.name;n.on("data",function(e){o=Buffer.concat([o,e])}),n.on("end",function(t){var t={Bucket:"joyage-images",Key:r,Body:o,ContentType:mime.lookup(e.files.file.name)};s3.putObject(t,function(e){if(e)throw e}),i.status(200).json({imageurl:r}),console.log("Image uploaded")})})}),app.post("/uploadCornerPic",function(e,i){var t=path.join(__dirname,e.files.file.path);gm(t).resize(200,200).stream(function(t,n){var o=new Buffer(""),r="corner_"+Date.now()+e.files.file.name;n.on("data",function(e){o=Buffer.concat([o,e])}),n.on("end",function(t){var t={Bucket:"joyage-images",Key:r,Body:o,ContentType:mime.lookup(e.files.file.name)};s3.putObject(t,function(e){if(e)throw e}),i.status(200).json({imageurl:r}),console.log("Corner Pic uploaded")})})}),app.post("/uploadSelfie",function(e,i){var t=path.join(__dirname,e.files.file.path);gm(t).resize(200,200).stream(function(t,n){var o=new Buffer(""),r="selfie_"+Date.now()+e.files.file.name;console.log(r),n.on("data",function(e){o=Buffer.concat([o,e])}),n.on("end",function(t){var t={Bucket:"joyage-images",Key:r,Body:o,ContentType:mime.lookup(e.files.file.name)};console.log(t),s3.putObject(t,function(e){if(e)throw e;console.log("Selfie uploaded successfully")}),console.log("Selfie uploaded"),i.status(200).json({imageurl:r}).end()})})}),app.post("/api/activities",ensureAuthenticated,function(e,i,t){var n=new Activity({_id:e.body.id,title:e.body.title,description:e.body.description,genre:e.body.genre,dateOfActivity:e.body.dateOfActivity,endDateOfActivity:e.body.endDateOfActivity,timeOfActivity:e.body.timeOfActivity,timeAdded:new Date,city:e.body.city,location:e.body.location,address:e.body.address,phone:e.body.phone,sourceWebsite:e.body.sourceWebsite,locationWebsite:e.body.locationWebsite,neighborhood:e.body.neighborhood,country:e.body.country,mapLat:e.body.mapLat,mapLon:e.body.mapLon,status:e.body.status,poster:e.body.poster,photoCredit:e.body.photoCredit,photoCreditLink:e.body.photoCreditLink,currency:e.body.currency,price:e.body.price,facebookLink:e.body.facebookLink,zomatoLink:e.body.zomatoLink,twitterLink:e.body.twitterLink,payment:e.body.payment,bookRide:e.body.bookRide,goodies:e.body.goodies,moreInfo:e.body.moreInfo,moreInfoLink:e.body.moreInfoLink,sourceName:e.body.sourceName,sourceDescription:e.body.sourceDescription,addedBy:e.body.addedBy,corner:e.body.corner,cornerPic:e.body.cornerPic,cornerText:e.body.cornerText,media:e.body.media,selfie:[],selfie_sub:[],preview:!1});n.save(function(e){return e?t(e):void i.status(200).end()})}),app.put("/api/activities/:id",ensureAuthenticated,function(e,i,t){Activity.findById(e.params.id,function(n,o){return n?t(n):(o.title=e.body.title,o.description=e.body.description,o.genre=e.body.genre,o.dateOfActivity=e.body.dateOfActivity,o.endDateOfActivity=e.body.endDateOfActivity,o.timeOfActivity=e.body.timeOfActivity,o.city=e.body.city,o.neighborhood=e.body.neighborhood,o.location=e.body.location,o.address=e.body.address,o.phone=e.body.phone,o.country=e.body.country,o.sourceWebsite=e.body.sourceWebsite,o.locationWebsite=e.body.locationWebsite,o.poster=e.body.poster,o.photoCredit=e.body.photoCredit,o.photoCreditLink=e.body.photoCreditLink,o.currency=e.body.currency,o.price=e.body.price,o.facebookLink=e.body.facebookLink,o.twitterLink=e.body.twitterLink,o.zomatoLink=e.body.zomatoLink,o.payment=e.body.payment,o.bookRide=e.body.bookRide,o.goodies=e.body.goodies,o.moreInfo=e.body.moreInfo,o.moreInfoLink=e.body.moreInfoLink,o.sourceName=e.body.sourceName,o.sourceDescription=e.body.sourceDescription,o.corner=e.body.corner,o.cornerPic=e.body.cornerPic,o.cornerText=e.body.cornerText,o.media=e.body.media,void o.save(function(e){return e?t(e):void i.status(200).end()}))})}),app.post("/sendInvites",ensureAuthenticated,function(e,i,t){User.findById(e.body.id,function(n){return n?t(n):(console.log(e.body.id),console.log(e.body.response),console.log(e.body.response.to.length),void i.status(200).end())})}),app.post("/api/subscribe",ensureAuthenticated,function(e,i,t){User.findById(e.user._id,function(i,n){return i?t(i):(n.subscribedActivities.push(e.body.activityId),n.subscriptions?n.subscriptions+=1:n.subscriptions=1,void n.save(function(e){return e?t(e):void 0}))}),Activity.findById(e.body.activityId,function(n,o){return n?t(n):(o.subscribers.push(e.user._id),o.subscriptions?o.subscriptions+=1:o.subscriptions=1,void o.save(function(e){return e?t(e):void i.status(200).end()}))})}),app.post("/api/unsubscribe",ensureAuthenticated,function(e,i,t){User.findById(e.user._id,function(i,n){if(i)return t(i);var o=n.subscribedActivities.indexOf(e.body.activityId);n.subscribedActivities.splice(o,1),n.subscriptions-=1,n.save(function(e){return e?t(e):void 0})}),Activity.findById(e.body.activityId,function(n,o){if(n)return t(n);var r=o.subscribers.indexOf(e.user._id);o.subscribers.splice(r,1),o.subscriptions-=1,o.save(function(e){return e?t(e):void i.status(200).end()})})}),app.post("/api/markDone",ensureAuthenticated,function(e,i,t){User.findById(e.user._id,function(i,n){return i?t(i):(n.doneActivities.push(e.body.activityId),n.completions?n.completions+=1:n.completions=1,void n.save(function(e){return e?t(e):void 0}))}),Activity.findById(e.body.activityId,function(n,o){return n?t(n):(o.doneIt.push(e.user._id),o.completions?o.completions+=1:o.completions=1,void o.save(function(e){return e?t(e):void i.status(200).end()}))})}),app.post("/api/markUndone",ensureAuthenticated,function(e,i,t){User.findById(e.user._id,function(i,n){if(i)return t(i);var o=n.doneActivities.indexOf(e.body.activityId);n.doneActivities.splice(o,1),n.completions-=1,n.save(function(e){return e?t(e):void 0})}),Activity.findById(e.body.activityId,function(n,o){if(n)return t(n);var r=o.doneIt.indexOf(e.user._id);o.doneIt.splice(r,1),o.completions-=1,o.save(function(e){return e?t(e):void i.status(200).end()})})}),app.post("/mob_api/subscribe",function(e,i,t){User.findById(e.body.userId,function(i,n){return i?t(i):(n.subscribedActivities.push(e.body.activityId),n.subscriptions?n.subscriptions+=1:n.subscriptions=1,void n.save(function(e){return e?t(e):void 0}))}),Activity.findById(e.body.activityId,function(n,o){return n?t(n):(o.subscribers.push(e.body.userId),o.subscriptions?o.subscriptions+=1:o.subscriptions=1,void o.save(function(e){return e?t(e):void i.status(200).send({message:"Bookmarked"})}))})}),app.post("/mob_api/unsubscribe",function(e,i,t){User.findById(e.body.userId,function(i,n){if(i)return t(i);var o=n.subscribedActivities.indexOf(e.body.activityId);n.subscribedActivities.splice(o,1),n.subscriptions-=1,n.save(function(e){return e?t(e):void 0})}),Activity.findById(e.body.activityId,function(n,o){if(n)return t(n);var r=o.subscribers.indexOf(e.body.userId);o.subscribers.splice(r,1),o.subscriptions-=1,o.save(function(e){return e?t(e):void i.status(200).send({message:"Un-Bookmarked"})})})}),app.post("/mob_api/markDone",function(e,i,t){User.findById(e.body.userId,function(i,n){return i?t(i):(n.doneActivities.push(e.body.activityId),n.completions?n.completions+=1:n.completions=1,void n.save(function(e){return e?t(e):void 0}))}),Activity.findById(e.body.activityId,function(n,o){return n?t(n):(o.doneIt.push(e.body.userId),o.completions?o.completions+=1:o.completions=1,void o.save(function(e){return e?t(e):void i.status(200).send({message:"Marked as done"})}))})}),app.post("/mob_api/markUndone",ensureAuthenticated,function(e,i,t){User.findById(e.body.userId,function(i,n){if(i)return t(i);var o=n.doneActivities.indexOf(e.body.activityId);n.doneActivities.splice(o,1),n.completions-=1,n.save(function(e){return e?t(e):void 0})}),Activity.findById(e.body.activityId,function(n,o){if(n)return t(n);var r=o.doneIt.indexOf(e.body.userId);o.doneIt.splice(r,1),o.completions-=1,o.save(function(e){return e?t(e):void i.status(200).send({message:"Marked as Un-Done"})})})}),app.post("/api/selfies",ensureAuthenticated,function(e,i,t){User.findById(e.user._id,function(i,n){i&&t(i),n.selfies.push(e.body.selfies),n.save(function(e){e&&t(e)})}),Activity.findById(e.body.activityId,function(n,o){return n?t(n):(o.selfies.push({url:e.body.selfies,fbId:e.user.facebookId}),o.selfie_sub.push(e.user._id),void o.save(function(e){return e?t(e):void i.status(200).end()}))})}),app.post("/api/tips",ensureAuthenticated,function(e,i,t){User.findById(e.user._id,function(e,i){return e?t(e):(i.tipsCount?i.tipsCount+=1:i.tipsCount=1,void i.save(function(e){return e?t(e):void 0}))}),Activity.findById(e.body.activityId,function(n,o){return n?t(n):(o.tips.push({text:e.body.tips.splice(-1),tipperfbId:e.user.facebookId,tipper:e.user._id}),o.tipper.push(e.user._id),void o.save(function(e){return e?t(e):void i.status(200).end()}))})}),app.post("/mob_api/tips",function(e,i,t){User.findById(e.body.userId,function(e,i){return e?t(e):(i.tipsCount?i.tipsCount+=1:i.tipsCount=1,void i.save(function(e){return e?t(e):void 0}))}),Activity.findById(e.body.activityId,function(n,o){return n?t(n):(o.tips.push({text:e.body.tips.splice(-1),tipperfbId:e.user.facebookId,tipper:e.body.userId}),o.tipper.push(e.body.userId),void o.save(function(e){return e?t(e):void i.status(200).end()}))})}),app.post("/api/acceptActivity",ensureAuthenticated,function(e,i,t){User.findById(e.body.userId,function(n,o){return n?t(n):void(o.p2p===!0?Activity.findById(e.body.activityId,function(e,n){return e?t(e):(n.preview=!0,void n.save(function(e){return e?t(e):(console.log("Activity pushed into production"),void i.status(200).end())}))}):(console.log("Permission denied"),i.status(400).end()))})}),app.post("/api/deleteActivity",ensureAuthenticated,function(e,i,t){Activity.findById(e.body.activityId,function(e,n){return e?t(e):void n.remove(function(e){return e?t(e):(console.log("Activity deleted"),void i.send(200))})})}),app.get("/api/editActivity/:id",ensureAuthenticated,function(e,i,t){Activity.findById(e.params.id,function(e,n){return e?t(e):void i.send(n)})}),app.get("*",function(e,i){i.redirect("/#/"+e.originalUrl)}),app.use(function(e,i,t){console.error(e.stack),t.status(500).send({message:e.message})}),app.set("port",process.env.PORT||3e3);var server=app.listen(app.get("port"),function(){console.log("Express server listening on port "+app.get("port"))}),email;